{% extends 'core/base_public.html' %}
{% load crispy_forms_tags static %}

{% block title %}Tilmelding - Basal{% endblock %}

{% block extra_css %}
<style>
    .card { max-width: 700px; }
    .logo-header {
        background-color: var(--basal-purple);
        padding: 2rem;
        border-radius: 0.375rem 0.375rem 0 0;
        margin: -1px -1px 0 -1px;
    }
    .logo-header img {
        max-width: 200px;
        height: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="card shadow">
    <div class="logo-header text-center">
        <img src="{% static 'img/basal-logo-white.png' %}" alt="Basal">
    </div>
    <div class="card-body p-5">
        <div class="text-center mb-4">
            <h2>Tilmelding</h2>
            <p class="text-muted">Tilmeld dig et kommende kursus</p>
        </div>

        {% if form.errors %}
        <div class="alert alert-danger">Ret venligst fejlene nedenfor.</div>
        {% endif %}

        <div id="seats-warning" class="alert alert-warning" style="display: none;">
            <strong><i class="bi bi-exclamation-triangle me-2"></i>Bemærk:</strong>
            Din skole har ikke flere ledige pladser i jeres abonnement.
            I kan stadig tilmelde jer, og Basal vil kontakte jer angående udvidelse af jeres abonnement.
            <br><br>
            En ekstra plads koster ca. 8.000 kr.
            <a href="https://example.com/pricing.pdf" target="_blank" class="alert-link">Læs mere om priser her</a>.
        </div>

        <form method="post">
            {% csrf_token %}
            {% crispy form %}
        </form>
    </div>
</div>
<p class="text-center mt-3">
    <a href="{% url 'login' %}" class="text-muted">Medarbejder login</a>
</p>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const schoolSelect = document.getElementById('id_school');
        const newSchoolFields = document.getElementById('new-school-fields');
        const seatsWarning = document.getElementById('seats-warning');

        function toggleNewSchoolFields() {
            if (schoolSelect && newSchoolFields) {
                newSchoolFields.style.display = schoolSelect.value ? 'none' : 'block';
            }
        }

        function checkSchoolSeats() {
            if (!schoolSelect || !schoolSelect.value) {
                seatsWarning.style.display = 'none';
                return;
            }

            fetch('{% url "check-school-seats" %}?school_id=' + schoolSelect.value)
                .then(response => response.json())
                .then(data => {
                    if (data.has_available_seats === false) {
                        seatsWarning.style.display = 'block';
                    } else {
                        seatsWarning.style.display = 'none';
                    }
                })
                .catch(() => {
                    seatsWarning.style.display = 'none';
                });
        }

        if (schoolSelect) {
            schoolSelect.addEventListener('change', function() {
                toggleNewSchoolFields();
                checkSchoolSeats();
            });
            toggleNewSchoolFields();
            // Check seats on page load if school is already selected
            if (schoolSelect.value) {
                checkSchoolSeats();
            }
        }
    });
</script>
{% endblock %}
