{% extends 'core/base.html' %}

{% block title %}{{ school.name }} - Basal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-building me-2"></i>{{ school.name }}</h1>
    <div>
        <a href="{% url 'schools:update' school.pk %}" class="btn btn-outline-primary">
            <i class="bi bi-pencil me-1"></i>Rediger
        </a>
        <button type="button" class="btn btn-outline-secondary"
                hx-get="{% url 'schools:delete' school.pk %}"
                hx-target="#modal-container">
            <i class="bi bi-eye-slash me-1"></i>Deaktiver
        </button>
        <button type="button" class="btn btn-outline-danger"
                hx-get="{% url 'schools:hard-delete' school.pk %}"
                hx-target="#modal-container">
            <i class="bi bi-trash me-1"></i>Slet permanent
        </button>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">Skoleoplysninger</div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Adresse</dt>
                    <dd class="col-sm-8">{{ school.adresse }}</dd>
                    <dt class="col-sm-4">Kommune</dt>
                    <dd class="col-sm-8">{{ school.kommune }}</dd>
                    <dt class="col-sm-4">Tilmeldingsstatus</dt>
                    <dd class="col-sm-8">
                        {% if school.is_enrolled %}
                        <span class="badge bg-success">Tilmeldt</span>
                        {% if school.has_forankringsplads %}
                        <span class="badge bg-info ms-1">Forankringsplads</span>
                        {% endif %}
                        {% elif school.is_opted_out %}
                        <span class="badge bg-danger">Frameldt</span>
                        {% else %}
                        <span class="badge bg-secondary">Ikke tilmeldt</span>
                        {% endif %}
                    </dd>
                </dl>
                <div class="mt-3">
                    {% if school.is_enrolled %}
                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#enrollmentModal">
                        <i class="bi bi-x-circle me-1"></i>Frameld Basal
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#enrollmentModal">
                        <i class="bi bi-check-circle me-1"></i>Tilmeld Basal
                    </button>
                    {% endif %}
                </div>
                {% if enrollment_history %}
                <div class="mt-3">
                    <a class="text-decoration-none small" data-bs-toggle="collapse" href="#enrollmentHistory" role="button" aria-expanded="false" aria-controls="enrollmentHistory">
                        <i class="bi bi-chevron-down me-1"></i>Tilmeldingshistorik
                    </a>
                    <div class="collapse mt-2" id="enrollmentHistory">
                        <ul class="list-group list-group-flush small">
                            {% for event in enrollment_history %}
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                                <span class="text-muted">{{ event.date|date:"d. M Y" }}</span>
                                <span class="badge {% if event.event_type == 'enrolled' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ event.label }}
                                </span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
                {% if school.is_enrolled %}
                <div class="mt-3">
                    <a class="text-decoration-none small" data-bs-toggle="collapse" href="#credentialsSection" role="button" aria-expanded="false" aria-controls="credentialsSection">
                        <i class="bi bi-chevron-down me-1"></i>Kodeord og tilmeldingslink
                    </a>
                    <div class="collapse mt-2" id="credentialsSection">
                        <div class="bg-light p-3 rounded">
                            <p class="text-muted small mb-2">Bruges til kursustilmelding</p>
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">Kode</label>
                                <div class="input-group input-group-sm">
                                    <input type="password" class="form-control form-control-sm" id="signup-password"
                                           value="{{ school.signup_password }}" readonly>
                                    <button class="btn btn-outline-secondary btn-sm" type="button"
                                            onclick="togglePassword()" title="Vis/skjul">
                                        <i class="bi bi-eye" id="password-toggle-icon"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" type="button"
                                            onclick="copyToClipboard('signup-password')" title="Kopiér">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">Skolens side</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control form-control-sm" id="school-public-link"
                                           value="{{ request.scheme }}://{{ request.get_host }}/school/{{ school.signup_token }}/"
                                           readonly style="font-size: 0.75rem;">
                                    <button class="btn btn-outline-secondary btn-sm" type="button"
                                            onclick="copyToClipboard('school-public-link')" title="Kopiér">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">Tilmeldingslink</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control form-control-sm" id="signup-link"
                                           value="{{ request.scheme }}://{{ request.get_host }}/signup/course/?token={{ school.signup_token }}"
                                           readonly style="font-size: 0.75rem;">
                                    <button class="btn btn-outline-secondary btn-sm" type="button"
                                            onclick="copyToClipboard('signup-link')" title="Kopiér">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-warning btn-sm"
                                    hx-post="{% url 'schools:regenerate-credentials' school.pk %}"
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                    hx-confirm="Er du sikker? Den gamle kode vil ikke længere virke."
                                    hx-swap="none"
                                    onclick="setTimeout(function() { location.reload(); }, 500);">
                                <i class="bi bi-arrow-clockwise me-1"></i>Generer ny kode
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-people me-2"></i>Personer</span>
                <a href="{% url 'schools:person-create' school.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus-lg me-1"></i>Tilføj person
                </a>
            </div>
            <ul class="list-group list-group-flush">
                {% for person in people %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="mb-1">
                                <strong>{{ person.name }}</strong><span class="text-muted">, {{ person.display_role|lower }}</span>
                                {% if person.is_primary %}<span class="badge bg-primary ms-2">primær kontakt</span>{% endif %}
                            </div>
                            <div class="small text-muted">
                                {% if person.email %}<i class="bi bi-envelope me-1"></i><a href="mailto:{{ person.email }}">{{ person.email }}</a>{% endif %}
                                {% if person.email and person.phone %}<span class="mx-2">|</span>{% endif %}
                                {% if person.phone %}<i class="bi bi-telephone me-1"></i>{{ person.phone }}{% endif %}
                            </div>
                            {% if person.comment %}<div class="small mt-1">{{ person.comment }}</div>{% endif %}
                        </div>
                        <a href="{% url 'schools:person-update' person.pk %}" class="btn btn-sm btn-outline-secondary" title="Rediger">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </div>
                </li>
                {% empty %}
                {% if not course_signups %}
                <li class="list-group-item text-muted">Ingen personer tilføjet.</li>
                {% endif %}
                {% endfor %}

                {% for signup in course_signups %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="mb-1">
                                <strong>{{ signup.participant_name }}</strong>
                                {% if signup.participant_title %}<span class="text-muted">, {{ signup.participant_title|lower }}</span>{% endif %}
                            </div>
                            <div class="small text-muted">
                                {% if signup.participant_email %}<i class="bi bi-envelope me-1"></i><a href="mailto:{{ signup.participant_email }}">{{ signup.participant_email }}</a>{% endif %}
                                {% if signup.participant_email and signup.participant_phone %}<span class="mx-2">|</span>{% endif %}
                                {% if signup.participant_phone %}<i class="bi bi-telephone me-1"></i>{{ signup.participant_phone }}{% endif %}
                            </div>
                            <div class="small">
                                <a href="{% url 'courses:detail' signup.course.pk %}">{{ signup.course.title }}</a>
                                <span class="badge bg-{% if signup.attendance == 'present' %}success{% elif signup.attendance == 'absent' %}danger{% else %}secondary{% endif %} ms-1">
                                    {{ signup.get_attendance_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-receipt me-2"></i>Fakturaer</span>
                <a href="{% url 'schools:invoice-create' school.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus-lg me-1"></i>Tilføj faktura
                </a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Fakturanr.</th>
                            <th>Skoleår</th>
                            <th>Dato</th>
                            <th>Beløb</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                        <tr>
                            <td>{{ invoice.invoice_number }}</td>
                            <td>{% for year in invoice.school_years.all %}{{ year.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                            <td>{{ invoice.date|date:"d. M Y" }}</td>
                            <td>{{ invoice.amount|floatformat:2 }} kr.</td>
                            <td>
                                <span class="badge bg-{% if invoice.status == 'paid' %}success{% elif invoice.status == 'sent' %}warning{% else %}secondary{% endif %}">
                                    {{ invoice.get_status_display }}
                                </span>
                            </td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-link text-danger p-0" title="Slet"
                                        hx-get="{% url 'schools:invoice-delete' invoice.pk %}"
                                        hx-target="#modal-container">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">Ingen fakturaer.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <span><i class="bi bi-ticket-perforated me-2"></i>Pladser</span>
            </div>
            <div class="card-body">
                {% if school.is_enrolled %}
                {% if school.exceeds_seat_allocation %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Skolen har overskredet deres pladser.</strong>
                    De bruger {{ school.used_seats }} pladser men har kun {{ school.total_seats }} tildelt.
                    Der kan være behov for en ekstra faktura.
                </div>
                {% endif %}
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="fs-3 fw-bold text-primary">{{ school.total_seats }}</div>
                        <small class="text-muted">I alt</small>
                    </div>
                    <div class="col-4">
                        <div class="fs-3 fw-bold {% if school.exceeds_seat_allocation %}text-danger{% else %}text-secondary{% endif %}">{{ school.used_seats }}</div>
                        <small class="text-muted">Brugt</small>
                    </div>
                    <div class="col-4">
                        <div class="fs-3 fw-bold {% if school.remaining_seats > 0 %}text-success{% else %}text-danger{% endif %}">{{ school.remaining_seats }}</div>
                        <small class="text-muted">Ubrugte</small>
                    </div>
                </div>

                <hr>

                <dl class="row mb-0 small">
                    <dt class="col-8">Basispladser</dt>
                    <dd class="col-4 text-end">{{ school.base_seats }}</dd>
                    <dt class="col-8">Forankringsplads</dt>
                    <dd class="col-4 text-end">{{ school.forankring_seats }}</dd>
                    {% if school.purchased_seats > 0 %}
                    <dt class="col-8">Ekstra købte pladser</dt>
                    <dd class="col-4 text-end">{{ school.purchased_seats }}</dd>
                    {% endif %}
                </dl>

                {% if seat_purchases %}
                <hr>
                <small class="text-muted d-block mb-2">Købshistorik:</small>
                <ul class="list-unstyled small mb-0">
                    {% for purchase in seat_purchases %}
                    <li class="d-flex justify-content-between">
                        <span>{{ purchase.purchased_at|date:"d. M Y" }} - {{ purchase.seats }} plads{% if purchase.seats != 1 %}er{% endif %}</span>
                        {% if purchase.notes %}<span class="text-muted">{{ purchase.notes|truncatewords:5 }}</span>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% else %}
                <p class="text-muted mb-0">Skolen er ikke tilmeldt. <a href="{% url 'schools:update' school.pk %}">Rediger skolen</a> og sæt en tilmeldingsdato for at aktivere pladser.</p>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-chat-text me-2"></i>Kommentarer</span>
                <a href="{% url 'schools:comment-create' school.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus-lg me-1"></i>Tilføj kommentar
                </a>
            </div>
            <ul class="list-group list-group-flush">
                {% for comment in school_comments %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">{{ comment.created_at|date:"d. M Y" }}</small>
                                <small class="text-muted">{{ comment.created_by.get_full_name|default:comment.created_by.username|default:"Ukendt" }}</small>
                            </div>
                            <div>{{ comment.comment|linebreaks }}</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" title="Slet"
                                hx-get="{% url 'schools:comment-delete' comment.pk %}"
                                hx-target="#modal-container">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">Ingen kommentarer.</li>
                {% endfor %}
            </ul>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Henvendelser</span>
                <a href="{% url 'contacts:create' %}?school={{ school.pk }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus-lg"></i> Tilføj henvendelse
                </a>
            </div>
            <ul class="list-group list-group-flush">
                {% for contact in contact_history %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <strong>{{ contact.contacted_date|date:"d. M Y" }}</strong>
                        <small class="text-muted">{{ contact.created_by.get_full_name|default:contact.created_by.username|default:"Ukendt" }}</small>
                    </div>
                    <small>{{ contact.comment|truncatewords:20 }}</small>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">Ingen henvendelser.</li>
                {% endfor %}
            </ul>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history me-2"></i>Seneste aktivitet</span>
                <a href="{% url 'audit:school_activity' school.pk %}" class="btn btn-sm btn-outline-primary">
                    Se alle
                </a>
            </div>
            {% include "audit/includes/activity_table.html" with activities=recent_activities limit=5 %}
        </div>
    </div>
</div>

<!-- Enrollment Modal -->
<div class="modal fade" id="enrollmentModal" tabindex="-1" aria-labelledby="enrollmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="enrollmentModalLabel">
                    {% if school.is_enrolled %}Frameld Basal{% else %}Tilmeld Basal{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="enrollment-form" method="post" action="{% url 'schools:toggle-enrollment' school.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>
                        {% if school.is_enrolled %}
                        Du er ved at framelde <strong>{{ school.name }}</strong> fra Basal.
                        {% else %}
                        Du er ved at tilmelde <strong>{{ school.name }}</strong> til Basal.
                        {% endif %}
                    </p>
                    <div class="mb-3">
                        <label for="enrollment-date" class="form-label">
                            {% if school.is_enrolled %}Frameldingsdato{% else %}Tilmeldingsdato{% endif %}
                        </label>
                        <input type="date" class="form-control" id="enrollment-date" name="date"
                               value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuller</button>
                    {% if school.is_enrolled %}
                    <button type="submit" class="btn btn-danger">Frameld</button>
                    {% else %}
                    <button type="submit" class="btn btn-success">Tilmeld</button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function togglePassword() {
    const input = document.getElementById('signup-password');
    const icon = document.getElementById('password-toggle-icon');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

function copyToClipboard(elementId) {
    const input = document.getElementById(elementId);
    const originalType = input.type;
    input.type = 'text';
    input.select();
    document.execCommand('copy');
    input.type = originalType;

    // Show feedback
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i>';
    setTimeout(() => { btn.innerHTML = originalHtml; }, 1500);
}
</script>
{% endblock %}
