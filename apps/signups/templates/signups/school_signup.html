{% extends 'signups/base_signup.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ page.title|default:'Tilmeld din skole' }} - Basal{% endblock %}

{% block signup_content %}
<div class="text-center mb-4">
    <h2>{{ page.title|default:'Tilmeld din skole' }}</h2>
    {% if page.subtitle %}
    <p class="text-muted">{{ page.subtitle }}</p>
    {% endif %}
</div>

{% if page.intro_text %}
<div class="mb-4">
    {{ page.intro_text|safe }}
</div>
{% endif %}

{% if form.errors %}
<div class="alert alert-danger">Ret venligst fejlene nedenfor.</div>
{% endif %}

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% crispy form %}
</form>
{% endblock %}

{% block signup_footer %}
<p class="text-center mt-3">
    <a href="{% url 'signup:course' %}" class="text-muted">Allerede tilmeldt? Tilmeld dig et kursus</a>
    &nbsp;|&nbsp;
    <a href="{% url 'login' %}" class="text-muted">Medarbejder login</a>
</p>
{% endblock %}

{% block signup_extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const municipalitySelect = document.getElementById('id_municipality');
    const schoolSelect = document.getElementById('id_school');
    const schoolNotListedCheckbox = document.getElementById('id_school_not_listed');
    const newSchoolFields = document.getElementById('new-school-fields');
    const kommunenBetalerCheckbox = document.getElementById('id_kommunen_betaler');
    const billingFields = document.getElementById('billing-fields');

    // Titel "andet" handling
    const koordinatorTitel = document.getElementById('id_koordinator_titel');
    const koordinatorTitelOther = document.getElementById('id_koordinator_titel_other');
    const oekoTitel = document.getElementById('id_oeko_titel');
    const oekoTitelOther = document.getElementById('id_oeko_titel_other');

    function updateSchoolDropdown() {
        const kommune = municipalitySelect.value;
        if (!kommune) {
            schoolSelect.innerHTML = '<option value="">Vælg en skole...</option>';
            return;
        }

        fetch('{% url "signup:schools-by-kommune" %}?kommune=' + encodeURIComponent(kommune))
            .then(response => response.json())
            .then(data => {
                schoolSelect.innerHTML = '<option value="">Vælg en skole...</option>';
                data.schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    schoolSelect.appendChild(option);
                });
            })
            .catch(() => {
                schoolSelect.innerHTML = '<option value="">Fejl ved hentning af skoler</option>';
            });
    }

    function toggleNewSchoolFields() {
        if (schoolNotListedCheckbox && schoolNotListedCheckbox.checked) {
            if (schoolSelect) schoolSelect.closest('.mb-3')?.style.setProperty('display', 'none');
            if (newSchoolFields) newSchoolFields.style.display = 'block';
        } else {
            if (schoolSelect) schoolSelect.closest('.mb-3')?.style.removeProperty('display');
            if (newSchoolFields) newSchoolFields.style.display = 'none';
        }
    }

    function toggleBillingFields() {
        if (kommunenBetalerCheckbox && billingFields) {
            billingFields.style.display = kommunenBetalerCheckbox.checked ? 'block' : 'none';
        }
    }

    function toggleTitelOther(titelSelect, titelOtherInput) {
        if (titelSelect && titelOtherInput) {
            const container = titelOtherInput.closest('.mb-3') || titelOtherInput.closest('.col-md-3');
            if (container) {
                container.style.display = titelSelect.value === 'andet' ? '' : 'none';
            }
        }
    }

    // Municipality change handler
    if (municipalitySelect) {
        municipalitySelect.addEventListener('change', updateSchoolDropdown);
        if (municipalitySelect.value) {
            updateSchoolDropdown();
        }
    }

    // School not listed toggle
    if (schoolNotListedCheckbox) {
        schoolNotListedCheckbox.addEventListener('change', toggleNewSchoolFields);
        toggleNewSchoolFields();
    }

    // Billing fields toggle
    if (kommunenBetalerCheckbox) {
        kommunenBetalerCheckbox.addEventListener('change', toggleBillingFields);
        toggleBillingFields();
    }

    // Titel other field toggles
    if (koordinatorTitel) {
        koordinatorTitel.addEventListener('change', () => toggleTitelOther(koordinatorTitel, koordinatorTitelOther));
        toggleTitelOther(koordinatorTitel, koordinatorTitelOther);
    }
    if (oekoTitel) {
        oekoTitel.addEventListener('change', () => toggleTitelOther(oekoTitel, oekoTitelOther));
        toggleTitelOther(oekoTitel, oekoTitelOther);
    }
});
</script>
{% endblock %}
