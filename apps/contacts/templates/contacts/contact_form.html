{% extends 'core/base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if object %}Rediger{% else %}Tilføj{% endif %} henvendelse - Basal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-telephone me-2"></i>{% if object %}Rediger henvendelse{% else %}Tilføj henvendelse{% endif %}</h1>
</div>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            {% crispy form %}
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const schoolSelect = document.getElementById('id_school');
    const personsSection = document.getElementById('persons-section');
    const timeInput = document.getElementById('id_contacted_time');
    const dateInput = document.getElementById('id_contacted_date');

    // Add "Nu" button next to time field
    if (timeInput) {
        const wrapper = timeInput.closest('.time-field-wrapper') || timeInput.parentElement;
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        timeInput.parentNode.insertBefore(inputGroup, timeInput);
        inputGroup.appendChild(timeInput);

        const nowBtn = document.createElement('button');
        nowBtn.type = 'button';
        nowBtn.className = 'btn btn-outline-secondary';
        nowBtn.innerHTML = '<i class="bi bi-clock"></i> Nu';
        nowBtn.addEventListener('click', function() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            timeInput.value = `${hours}:${minutes}`;
        });
        inputGroup.appendChild(nowBtn);
    }

    // Ensure date is prefilled with today
    if (dateInput && !dateInput.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;
    }

    if (!schoolSelect || !personsSection) return;

    function updatePersons(schoolId) {
        if (!schoolId) {
            personsSection.style.display = 'none';
            return;
        }

        fetch('{% url "contacts:school-persons" %}?school_id=' + schoolId)
            .then(response => response.json())
            .then(data => {
                let personsContainer = personsSection.querySelector('#div_id_contacted_persons');
                if (!personsContainer) {
                    personsContainer = document.createElement('div');
                    personsContainer.id = 'div_id_contacted_persons';
                    personsContainer.className = 'mb-3';
                    const label = personsSection.querySelector('label.form-label');
                    if (label) {
                        label.after(personsContainer);
                    } else {
                        personsSection.prepend(personsContainer);
                    }
                }

                if (data.persons.length === 0) {
                    personsContainer.innerHTML = '<p class="text-muted small">Ingen kontaktpersoner registreret for denne skole.</p>';
                } else {
                    let html = '';
                    data.persons.forEach(person => {
                        const title = person.title ? ` (${person.title})` : '';
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="contacted_persons" value="${person.id}" id="person_${person.id}">
                                <label class="form-check-label" for="person_${person.id}">
                                    ${person.name}${title}
                                </label>
                            </div>
                        `;
                    });
                    personsContainer.innerHTML = html;
                }

                personsSection.style.display = 'block';
            })
            .catch(() => {
                personsSection.style.display = 'none';
            });
    }

    schoolSelect.addEventListener('change', function() {
        updatePersons(this.value);
    });

    if (schoolSelect.value) {
        personsSection.style.display = 'block';
    } else {
        personsSection.style.display = 'none';
    }
});
</script>
{% endblock %}
